{% extends "base.html" %}
{% block title %}Ungrouped Files{% endblock %}

{% block content %}
<h2 style="color:#004aad; text-align:center;">üìÅ Ungrouped Files</h2>

<div class="group-actions">
    <button class="btn btn-blue" id="downloadAllBtn">‚¨áÔ∏è Download All (ZIP)</button>
    <button class="btn btn-red" id="deleteAllBtn">üóëÔ∏è Delete All</button>
</div>

<div class="file-list-container">
{% if files %}
    <ul class="file-list">
        {% for file in files %}
            <li class="file-item">
                <div class="file-info">
                    <a href="{{ file.file.url }}" target="_blank" class="file-name">
                        üìÑ {{ file.title|default:file.file.name|slice:"30:" }}
                    </a>
                    <small class="file-date">{{ file.uploaded_at|date:"Y-m-d H:i" }}</small>
                </div>
                <form method="post" action="{% url 'patients:delete_ungrouped_file' file.id %}" class="inline-form" 
                      onsubmit="return confirm('Are you sure you want to delete this file?');">
                    {% csrf_token %}
                    <button type="submit" class="btn btn-red btn-sm">Delete</button>
                </form>
            </li>
        {% endfor %}
    </ul>
{% else %}
    <p style="text-align:center; color:#555;">No ungrouped files found.</p>
{% endif %}
</div>

<div style="text-align:center; margin-top:20px;">
    <a href="{% url 'patients:batch_upload' %}" class="btn btn-outline">‚¨ÜÔ∏è Upload More Files</a>
</div>

<!-- Delete All Confirmation Popup -->
<div id="confirmDeletePopup" class="popup-overlay">
  <div class="popup-box">
    <h3>‚ö†Ô∏è Confirm Deletion</h3>
    <p>Are you sure you want to delete all ungrouped files? <br>
    <strong style="color:red;">This action cannot be undone.</strong></p>
    <div class="popup-actions">
      <form method="POST" action="{% url 'patients:delete_all_ungrouped' %}">
        {% csrf_token %}
        <button type="submit" class="btn btn-red">Yes, Delete All</button>
      </form>
      <button class="btn btn-outline" id="cancelDeleteBtn">Cancel</button>
    </div>
  </div>
</div>

<style>
/* Main container */
.file-list-container {
    max-width: 700px;
    margin: 30px auto;
    background: white;
    border-radius: 12px;
    box-shadow: 0 0 10px rgba(0,0,0,0.1);
    padding: 25px;
}

/* File list style */
.file-list {
    list-style: none;
    padding: 0;
    margin: 0;
}
.file-item {
    display: flex;
    justify-content: space-between;
    align-items: center;
    border-bottom: 1px solid #eee;
    padding: 10px 0;
}
.file-item:last-child {
    border-bottom: none;
}
.file-name {
    text-decoration: none;
    color: #004aad;
    font-weight: 500;
}
.file-name:hover {
    text-decoration: underline;
}
.file-date {
    color: #888;
    font-size: 13px;
    margin-left: 10px;
}

/* Action buttons */
.btn {
    padding: 8px 16px;
    border-radius: 8px;
    font-size: 14px;
    cursor: pointer;
    border: none;
    transition: all 0.2s ease;
}
.btn:hover { transform: translateY(-2px); }
.btn-blue { background-color: #004aad; color: white; }
.btn-red { background-color: #dc3545; color: white; }
.btn-outline {
    background: white;
    border: 1px solid #ccc;
    color: #333;
}
.btn-sm { padding: 5px 10px; font-size: 13px; }

.group-actions {
    text-align: center;
    margin-bottom: 20px;
}

/* Popup styles */
.popup-overlay {
    display: none;
    position: fixed;
    top: 0; left: 0;
    width: 100%; height: 100%;
    background: rgba(0,0,0,0.4);
    justify-content: center;
    align-items: center;
    z-index: 9999;
    animation: fadeIn 0.3s ease;
}
.popup-box {
    background: white;
    padding: 30px 40px;
    border-radius: 12px;
    text-align: center;
    box-shadow: 0 4px 20px rgba(0,0,0,0.3);
    animation: slideUp 0.3s ease;
}
.popup-actions {
    margin-top: 20px;
}
@keyframes fadeIn {
    from { opacity: 0; } to { opacity: 1; }
}
@keyframes slideUp {
    from { transform: translateY(30px); opacity: 0; }
    to { transform: translateY(0); opacity: 1; }
}
</style>

<script>
document.addEventListener("DOMContentLoaded", function() {
    const deleteBtn = document.getElementById("deleteAllBtn");
    const popup = document.getElementById("confirmDeletePopup");
    const cancelBtn = document.getElementById("cancelDeleteBtn");
    const downloadBtn = document.getElementById("downloadAllBtn");

    deleteBtn.addEventListener("click", () => popup.style.display = "flex");
    cancelBtn.addEventListener("click", () => popup.style.display = "none");

    downloadBtn.addEventListener("click", () => {
        window.location.href = "{% url 'patients:download_ungrouped' %}";
    });

    window.addEventListener("click", (e) => {
        if (e.target === popup) popup.style.display = "none";
    });
});
</script>
{% endblock %}
